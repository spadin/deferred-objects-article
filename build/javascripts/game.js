!function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};window.Game=function(){function t(t){null==t&&(t={}),this.timerUpdate=e(this.timerUpdate,this),this.element=t.element||$("#mouse-dexterity-game"),this.template=t.template||JST["templates/game"],this.gameover=!1,this.timer=new Timer,this.timer.progress(this.timerUpdate),this.render()}return t.prototype.timerUpdate=function(e){return this.printMessage(e/1e3)},t.prototype.render=function(){return this.element.append(this.template()),this.messageElement=$(".message",this.element)},t.prototype.startTimer=function(){return this.timer.start()},t.prototype.stopTimer=function(){return this.timer.stop()},t.prototype.renderBoard=function(){var e=this;return $(".board",this.element).empty(),_.each(this.board.getPieces(),function(t){return $(".board",e.element).append(t.render())})},t.prototype.bindBoard=function(){var e,t,r,n=this;return r=function(){var e,r,n,i;for(n=this.board.getSafePieces(),i=[],e=0,r=n.length;r>e;e++)t=n[e],i.push(t.promise());return i}.call(this),e=function(){var e,r,n,i;for(n=this.board.getNonSafePieces(),i=[],e=0,r=n.length;r>e;e++)t=n[e],i.push(t.promise());return i}.call(this),$.when.apply($,r).then(function(){return n.handleGameover(!0)}),_.each(r,function(e){var t;return t=e.promise(),$.when(t).then(function(e){var t;return t=e.currentTarget,$(t).css("opacity","1"),n.running||n.gameover||($("img").hide(),n.running=!0),n.startTimer()})}),_.each(e,function(e){var t;return t=e.promise(),$.when(t).then(function(){return n.handleGameover(!1),n.reset()})})},t.prototype.setup=function(e){var t,r;return this.map=e,t=function(){var t,n,i;for(i=[],t=0,n=e.length;n>t;t++)r=e[t],i.push(new Piece({safe:r}));return i}(),this.board=new Board({pieces:t}),this.gameover=!1,this.renderBoard(),this.bindBoard()},t.prototype.printMessage=function(e){return this.messageElement.text(e)},t.prototype.reset=function(){return this.running=!1,this.setup(this.map),this.timer.reset()},t.prototype.handleGameover=function(e){return this.winner=e,this.stopTimer(),this.gameover=!0,this.printMessage(this.winner?"You win! "+this.timer.elapsedTime/1e3:"You lose, try again."),$("img").hide(),this.winner&&$("img.win",this.element).show(),this.winner?void 0:$("img.lose",this.element).show()},t.prototype.isGameover=function(){return this.gameover},t}()}.call(this);